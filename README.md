# Job Notifier - Telegram Ingestion Service

A production-ready Python service that automatically fetches job postings from Telegram groups and stores them in a MySQL database for further processing and analysis.

## Description

This service monitors specified Telegram groups/channels for new messages, extracts job-related content, and stores it in a structured MySQL database. The system is designed for automated, non-interactive operation and can be easily integrated with job schedulers or cron systems.

## Key Features

- **Secure Session Authentication**: Uses pre-generated session strings instead of storing API credentials
- **Automated & Non-Interactive**: Runs without user input, perfect for scheduled execution
- **MySQL Integration**: Efficient batch processing with duplicate prevention
- **Robust Logging**: 72-hour log retention with automatic rotation
- **Error Resilience**: Individual group failures don't crash the entire process
- **Configurable Groups**: Monitor multiple Telegram groups via environment variables
- **Production Ready**: Clean separation between service code and testing utilities

## Setup and Usage

### 1. Install Dependencies
```bash
pip install -r requirements.txt
```

### 2. Configure Environment Variables
```bash
# Copy the template
cp .env.example .env

# Edit .env with your actual values
```

### 3. Generate Telegram Session (One-Time Setup)
```bash
# Add your API credentials to .env first
python generate_session.py

# Copy the generated session string to .env
```

### 4. Configure Target Groups
Edit your `.env` file and set the `TELEGRAM_GROUPS` variable:
```
TELEGRAM_GROUPS=Tech Jobs,Python Jobs,Remote Work
```

### 5. Test the Service
```bash
python manual_test.py
```

### 6. Production Integration
Import and use the service in your scheduler:
```python
from ingest import run_fetcher_task
from datetime import datetime, timedelta

config = {
    'last_fetched_at': datetime.now() - timedelta(hours=1)
}

await run_fetcher_task(config)
```

## Configuration

### Environment Variables

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `TELEGRAM_SESSION_STRING` | Pre-generated session for authentication | Yes | Generated by `generate_session.py` |
| `TELEGRAM_GROUPS` | Comma-separated list of groups to monitor | Yes | `"Tech Jobs,Dev Careers"` |
| `DATABASE_URL` | MySQL connection string | Yes | `mysql://user:pass@host:3306/db` |
| `TELEGRAM_API_ID` | API ID from my.telegram.org (setup only) | Setup | `12345678` |
| `TELEGRAM_API_HASH` | API Hash from my.telegram.org (setup only) | Setup | `abcdef123456...` |
| `TELEGRAM_PHONE_NUMBER` | Phone number for initial auth (setup only) | Setup | `+1234567890` |

### Database Schema

The service expects a MySQL table named `JobNotification` with the following structure:

```sql
CREATE TABLE JobNotification (
    id INT AUTO_INCREMENT PRIMARY KEY,
    message_id BIGINT NOT NULL,
    group_id BIGINT NOT NULL,
    job_post_text TEXT,
    status VARCHAR(50) DEFAULT 'pending_ai_review',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_message (message_id, group_id)
);
```

### Automated Cleanup

Set up this MySQL event for automatic cleanup of old records:

```sql
CREATE EVENT IF NOT EXISTS cleanup_old_notifications
ON SCHEDULE EVERY 1 DAY
STARTS CURRENT_TIMESTAMP
DO
DELETE FROM JobNotification 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 48 HOUR);
```

## File Structure

```
├── ingest.py           # Main production service
├── generate_session.py # One-time session generator
├── manual_test.py      # Testing utility
├── requirements.txt    # Python dependencies
├── .env.example       # Configuration template
├── .gitignore         # Git ignore rules
└── README.md          # This file
```

## Security Notes

- Never commit `.env` files or `*.session` files to version control
- The session string provides full account access - keep it secure
- Use the `.env.example` template for sharing configuration structure
- API credentials are only needed once for session generation

## Logging

- Logs are written to `ingest.log`
- Files rotate every 12 hours with 6 files retained (72 hours total)
- Each log entry includes timestamp, level, and detailed message
- No sensitive information is logged